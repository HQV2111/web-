<script>
  let transferCounter = 1001;
  const KEY_API_BASE = "https://script.google.com/macros/s/AKfycbz9koZ1y6faFiU7pVXJ43FHEPYn_A1Ek8A0T7MsCoMiAO-lhoLMMwb0MndlYlMhc9CP/exec";

  const sheetMap = {
    "1d": "key24h",
    "7d": "key7day",
    "30d": "key30day"
  };

  function copyToClipboard(text) {
    navigator.clipboard.writeText(text).then(() => alert("Đã copy: " + text));
  }

  function confirmPayment() {
    const duration = document.querySelector("select[name='duration']").value;
    const sheet = sheetMap[duration];
    if (!sheet) {
      alert("Không xác định được thời hạn.");
      return;
    }

    fetch(`${KEY_API_BASE}?sheet=${sheet}`)
      .then(res => res.text())
      .then(key => {
        document.getElementById("userKey").innerText = key;
        document.getElementById("keySection").style.display = "block";
      })
      .catch(err => alert("Lỗi lấy key: " + err));
  }

  document.getElementById("invoiceUpload").addEventListener("change", function(event) {
    const file = event.target.files[0];
    const reader = new FileReader();
    reader.onload = function(e) {
      const preview = document.getElementById("previewImg");
      preview.src = e.target.result;
      preview.style.display = "block";
    };
    if (file) reader.readAsDataURL(file);
  });

  document.getElementById("orderForm").addEventListener("submit", function(e) {
    e.preventDefault();
    const form = new FormData(e.target);
    const game = form.get("game");
    const duration = form.get("duration");

    const gameMap = {
      "lienquan": "Liên Quân Mobile",
      "pubg": "PUBG Mobile",
      "playtogether": "Play Together VNG"
    };

    const durationMap = {
      "1d": "1 ngày",
      "7d": "7 ngày",
      "30d": "30 ngày"
    };

    transferCounter++;
    document.getElementById("summaryProduct").innerText = `${durationMap[duration]} | ${gameMap[game]}`;
    document.getElementById("transferNote").innerText = "NAP" + transferCounter;
    document.getElementById("paymentInfo").style.display = "block";
    window.scrollTo({ top: document.body.scrollHeight, behavior: "smooth" });
  });
</script>
